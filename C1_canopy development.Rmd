---
title: "R Notebook"
output: html_notebook
---

###Canopy analysis

```{r Load, warning=FALSE, fig.height=8, fig.width=8}
# install.packages("zoo")
library(dplyr)
library(ggplot2)
library(lubridate)   
library(hydroGOF)
library(xtable)
library(knitr)
library(tidyr)
library(RSQLite)
library(agricolae)
library(scales)
library(zoo)
library(lme4)
library(reshape2)
```
## lode observed data
```{r}
upDir <- "D:/R/CombinedData/"
obsData <- "D:/R/CombinedData/"

obsAll <- read.table(paste0(obsData, "ObsAll.txt"),
                   header = TRUE)
obsA1<- obsAll %>%
  dplyr::filter(Collection=="2000_2002")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
 mutate(Rotation2=as.factor(ifelse(Rotation=="1",paste0("S",Rotation),paste0("R",Rotation))))

obsA4<- obsAll %>%
  dplyr::filter(Collection=="2014_2018")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
  mutate(Rotation2=as.factor(ifelse(Rotation=="1",paste0("S",Rotation),paste0("R",Rotation))))
 

  obsA2<- obsAll %>%
  dplyr::filter(Collection=="1997_2001")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
  mutate(Rotation2=as.factor(paste0("R",Rotation)))
  

  obsA3<- obsAll %>%
  dplyr::filter(Collection=="2002_2004")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
  mutate(Rotation2=as.factor(paste0("R",Rotation)))
  
obsA<-rbind(obsA2,obsA3,obsA1,obsA4)
summary(obsA)
 obsA
```
#Load Tt and Join Observed data together
##Select LAI variable
```{r}
upDir <- "D:/R/"
obsData <- "D:/R/TtAll/"

Tt<- read.table(paste0(obsData, "df.all.txt"),
               header = TRUE)
TtA <- Tt %>% mutate(Clock.Today=dmy(Clock.Today), ExpUnitCode=as.factor(ExpName))
TtA
ObsL.Raw <-merge(obsA,TtA,by=c("Clock.Today","ExpUnitCode"))
ObsL<-ObsL.Raw%>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(FD.x=="FD5")%>%
  dplyr::filter(Variable=="LAI"|Variable=="NodeNumber")%>%
  dplyr::filter(Tbb==1)
  

summary(ObsL)
```



```{r}
ObsLF<-ObsL%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="11")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="22")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="31")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthSeason.x!="4")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="57")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="61")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="14")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="36")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="37")%>%
 #dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthSeason.x!="4")%>%
 dplyr::filter(Name!="Iversen_9SowingDateSD1Waterirr"|GrowthRotation!="14")%>%
 dplyr::filter(Name!="Iversen_9SowingDateSD2Waterirr"|GrowthRotation!="21")%>%
 dplyr::filter(Name!="Iversen_9SowingDateSD2Waterirr"|GrowthRotation!="13")%>%
  dplyr::filter(Name!="Iversen_9SowingDateSD3Waterirr"|GrowthRotation!="21")%>%
  dplyr::filter(Name!="Iversen_9SowingDateSD4Waterirr"|GrowthRotation!="21")


```

# Create and test interpolation function 

###Node appearance data preparation
###Node appearance interpolate for each rotation
```{r}

# add function to "turn-off" rowise() in dplyr. FIXME: maybe there's a better/simpler solution?

UniExp <- unique(ObsLF$ExpUnitCode)

Inte.df <- data.frame()
  
for(i in 1:length(UniExp))
{
  
  ObsLA<-ObsLF%>%
   filter(ExpUnitCode==UniExp[i])
  
 LN<-ObsLA%>%
  unique()%>%
  tidyr::spread(Variable,Observed)
 
 LN.data<-LN%>%
  mutate( NodeNumber.y=approx(LN$Clock.Today, LN$NodeNumber, xout =LN$Clock.Today, 
         method="linear", 
         rule = 2)$y)##interpolate function 
  

 Inte.df <- rbind(Inte.df, LN.data)

}

summary(Inte.df)
Inte.df
#write.csv(df.all,"D:/R/TtAll/df.all.csv", row.names = FALSE)

```
###Plot LAI against Nodenumber
##Regrowth
```{r,fig.height=5, fig.width=10}
phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
Inte.df.Pp<- merge(StartGrazing1,Inte.df,by=c("Name","Collection","GrowthRotation"))


Leaf_Node<-Inte.df.Pp%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(LAI!=is.na(LAI))%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="13")
df<-data.frame(a=c(2, 4.3, 7.8, 10,11),b=c(0, 1, 4, 6,7))
#dfs<-data.frame(c=c(6,7.5,10.5,11),d=c(0,1,3,3.4))
Leaf_Node%>%
 dplyr::filter(NodeNumber.y<=11)%>%
  #dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  ggplot(aes(x=NodeNumber.y,y=LAI, color=Name))+theme_bw()+xlab("Node Number")+ylab("LAI(m^2/m^2)")+ 
  geom_line(data=df,aes(x=a,y=b), color="red")+
  #geom_line(data=dfs,aes(x=c,y=d),color="blue")+
  geom_point(size=2)+
  #geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #geom_text()+
  facet_wrap(~Stage,ncol=1)+
  #facet_grid(Trend~Stage)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

  
```
```{r,fig.height=5, fig.width=10}
Leaf_Node1<-Inte.df.Pp%>%
  dplyr::filter(Stage=="Seedling")%>%
  dplyr::filter(LAI!=is.na(LAI))%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="13")
#df<-data.frame(a=c(2, 4.3, 7.8, 10,11),b=c(0, 1, 4, 6,7))
dfs<-data.frame(c=c(6,7.5,10.5,11),d=c(0,1,3,3.4))
Leaf_Node1%>%
 dplyr::filter(NodeNumber.y<=11)%>%
  #dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  ggplot(aes(x=NodeNumber.y,y=LAI, color=Name))+theme_bw()+xlab("Node Number")+ylab("LAI(m^2/m^2)")+ 
  #geom_line(data=df,aes(x=a,y=b), color="red")+
  geom_line(data=dfs,aes(x=c,y=d),color="blue")+
  geom_point(size=2)+
  #geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #geom_text()+
  facet_wrap(~Stage,ncol=1)+
  #facet_grid(Trend~Stage)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
  
```
#Load Tt and Join Observed data together
##Select LAI variable
```{r}
upDir <- "D:/R/"
obsData <- "D:/R/TtAll/"

Tt<- read.table(paste0(obsData, "df.all.txt"),
               header = TRUE)
TtA <- Tt %>% mutate(Clock.Today=dmy(Clock.Today), ExpUnitCode=as.factor(ExpName))
TtA
ObsL.Raw <-merge(obsA,TtA,by=c("Clock.Today","ExpUnitCode"))
ObsL<-ObsL.Raw%>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(FD.x=="FD5")%>%
  dplyr::filter(Variable=="LAI"|Variable=="Height")%>%
  dplyr::filter(Tbb==1)
  

summary(ObsL)
```



```{r}
ObsLH<-ObsL%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="11")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="22")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="31")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="36")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthSeason.x!="4")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="57")%>%
  dplyr::filter(Name!="Iversen_8Waterirr"|GrowthRotation!="61")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="14")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="36")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="37")%>%
 #dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthSeason.x!="4")%>%
 dplyr::filter(Name!="Iversen_9SowingDateSD1Waterirr"|GrowthRotation!="14")%>%
 dplyr::filter(Name!="Iversen_9SowingDateSD2Waterirr"|GrowthRotation!="21")%>%
 dplyr::filter(Name!="Iversen_9SowingDateSD2Waterirr"|GrowthRotation!="13")%>%
  dplyr::filter(Name!="Iversen_9SowingDateSD3Waterirr"|GrowthRotation!="21")%>%
  dplyr::filter(Name!="Iversen_9SowingDateSD4Waterirr"|GrowthRotation!="21")


```

# Create and test interpolation function 

###Node appearance data preparation
###Node appearance interpolate for each rotation
```{r}

# add function to "turn-off" rowise() in dplyr. FIXME: maybe there's a better/simpler solution?

UniExp <- unique(ObsLH$ExpUnitCode)

Inte.df <- data.frame()
  
for(i in 1:length(UniExp))
{
  
  ObsLA<-ObsLH%>%
   filter(ExpUnitCode==UniExp[i])
  
 LN<-ObsLA%>%
  unique()%>%
  tidyr::spread(Variable,Observed)
 
 LN.data<-LN%>%
  mutate( Height.y=approx(LN$Clock.Today, LN$Height, xout =LN$Clock.Today, 
         method="linear", 
         rule = 2)$y)##interpolate function 
  

 Inte.df <- rbind(Inte.df, LN.data)

}

summary(Inte.df)
Inte.df
#write.csv(df.all,"D:/R/TtAll/df.all.csv", row.names = FALSE)

```
###Plot LAI against Nodenumber
##Regrowth
```{r,fig.height=5, fig.width=10}
phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
Inte.df.Pp<- merge(StartGrazing1,Inte.df,by=c("Name","Collection","GrowthRotation"))


Leaf_height<-Inte.df.Pp%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(LAI!=is.na(LAI))%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="13")%>%
  dplyr::filter(Collection!="2002_2004")%>%
  dplyr::filter(Name!="Iversen_8Waterirr")%>%
  mutate(Height.y=Height.y*10)

Leaf_height2<-Inte.df.Pp%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(LAI!=is.na(LAI))%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="13")%>%
  dplyr::filter(Collection!="2000_2002")%>%
  dplyr::filter(Collection!="2014_2018")
  
  
      
LeafH<-rbind(Leaf_height,Leaf_height2)
#df<-data.frame(a=c(2, 4.3, 7.8, 10,11),b=c(0, 1, 4, 6,7))
#dfs<-data.frame(c=c(6,7.5,10.5,11),d=c(0,1,3,3.4))
LeafH%>%
 #dplyr::filter(Height.y<=11)%>%
  #dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  ggplot(aes(x=Height.y,y=LAI, color=Name))+theme_bw()+xlab("Height")+ylab("LAI(m^2/m^2)")+ 
  #geom_line(data=df,aes(x=a,y=b), color="red")+
  #geom_line(data=dfs,aes(x=c,y=d),color="blue")+
  geom_point(size=2)+
  #geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #geom_text()+
  facet_wrap(~Stage,ncol=1)+
  #facet_grid(Trend~Stage)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

  
```
```{r,fig.height=5, fig.width=10}
Leaf_height1<-Inte.df.Pp%>%
  dplyr::filter(Stage=="Seedling")%>%
  dplyr::filter(LAI!=is.na(LAI))%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="13")
#df<-data.frame(a=c(2, 4.3, 7.8, 10,11),b=c(0, 1, 4, 6,7))
#dfs<-data.frame(c=c(6,7.5,10.5,11),d=c(0,1,3,3.4))
Leaf_height1%>%
 #dplyr::filter(Height.y<=11)%>%
  #dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  ggplot(aes(x=Height.y,y=LAI, color=Name))+theme_bw()+xlab("Height")+ylab("LAI(m^2/m^2)")+ 
  #geom_line(data=df,aes(x=a,y=b), color="red")+
  #geom_line(data=dfs,aes(x=c,y=d),color="blue")+
  geom_point(size=2)+
  #geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #geom_text()+
  facet_wrap(~Stage,ncol=1)+
  #facet_grid(Trend~Stage)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
  
```

####analysis
```{r}
Leaf_Node1<-Leaf_Node%>%
  dplyr::filter(Stage!="Seedling")
x=Leaf_Node1$NodeNumber.y
y=Leaf_Node1$LAI

#mdl1 <- lm(y ~ x, data = Leaf_Node1)
#mdl2 <- lm(y ~ x + I(x^2), data = Leaf_Node1)
#mdl3 <- lm(y ~ x + I(x^2) + I(x^3), data = Leaf_Node1)
mdl4 <- lm(y ~ I(x^2), data = Leaf_Node1)
#mdl5<-lm(y ~ poly(x, 2, raw=TRUE),data = Leaf_Node1 )
summary(mdl4)

prd <- data.frame(x = seq(2, 14, by = 0.1))

result <- prd
#result$mdl1 <- predict(mdl1, newdata = prd)
#result$mdl2 <- predict(mdl2, newdata = prd)
#result$mdl3 <- predict(mdl3, newdata = prd)
result$mdl4 <- predict(mdl4, newdata = prd)
#result$mdl5 <- predict(mdl5, newdata = prd)

result <-  melt(result, id.vars = "x", variable.name = "model",
                value.name = "fitted")
ggplot(result, aes(x = x, y = fitted)) +
  theme_bw() +
  facet_wrap(~Stage,ncol=2)+
  geom_point(data = Leaf_Node1, aes(x = x, y = y)) +xlab("Main node number")+ylab("LAI (m^2/m^2)")+
  geom_line(aes(colour = model), size = 1)+
  theme(legend.title=element_blank(),legend.position = "blank")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
```
###LAI aganist node number

```{r,fig.height=6, fig.width=10}
Leaf_Nodef<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_8Waterirr")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Nodef%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_8Waterirr")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```
```{r,fig.height=6, fig.width=10}
Leaf_Node2<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Node2%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
 geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_91DefoliationLL")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```
```{r,fig.height=4, fig.width=10}
Leaf_Node3<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD1Waterirr")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Node3%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_9SowingDateSD1Waterirr")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```
```{r,fig.height=3, fig.width=10}
Leaf_Node4<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD2Waterirr")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Node4%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_9SowingDateSD2Waterirr")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```

```{r,fig.height=3, fig.width=10}
Leaf_Node5<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD3Waterirr")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Node5%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_9SowingDateSD3Waterirr")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```
```{r,fig.height=4, fig.width=10}
Leaf_Node6<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD4Waterirr")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Node6%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_9SowingDateSD4Waterirr")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```


```{r,fig.height=6, fig.width=10}
Leaf_Node7<-Leaf_Node%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(NodeNumber.y<=11)

Leaf_Node7%>%
  ggplot(aes(x=NodeNumber.y, y=LAI))+geom_point(size=2)+theme_bw()+ylab("LAI (m^2/m^2)")+xlab("Node number")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")
 facet_grid(GrowthSeason.x~Rotation.x)+ggtitle("Iversen_121DefoliationLLFDFD5")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

```
```{r}
SlopeLN<-Leaf_Node%>%
  dplyr::filter(NodeNumber.y<=11)%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Tmean,Ppm,Stage,Ps,Collection,GrowthRotation,Trend)%>%
 do(mod = lm(LAI~NodeNumber.y,data=.)) %>%
  mutate(slopeLN = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)

SlopeLN%>%
  dplyr::filter(Stage!="Seedling")%>%
   ggplot(aes(x=Ppm, y=slopeLN,color=Name,label=GrowthRotation))+
  #geom_point(size=2)+
  geom_text()+
  theme_bw()+ylab("LAI per node")+xlab("Photoperiod (h)")+ 
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
  #stat_smooth(method="nls",formula =  y~a*exp(-x*b),method.args=list(start=c(a=2,b=2)),se=F,color="red")+
  #stat_smooth(method="lm",formula =  y~exp(-x),se=F,color="blue")+
 facet_wrap(~Trend,ncol=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))


```

####leaf area mutiple regression
```{r}
Leaf_Node
M.mode<-lm(LAI~Tt_broken_sum+Ppm+NodeNumber.y,data=Leaf_Node)
summary(M.mode)

LeafH
M.mode1<-lm(LAI~Tt_broken_sum+Ppm+Height.y,data=LeafH)
summary(M.mode1)

```
### ananlysis of LAI aganist thermal time
```{r}
obsLAIanalysis<- ObsLF%>%
  dplyr::filter(Variable=="LAI")%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection) %>%
  do(mod = lm(Tt_broken_sum~Observed,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
  mutate(R2 = summary(mod)$r.squared)%>%
  mutate(P=anova(mod)$'Pr(>F)'[1])%>%  
  mutate(intcp= summary(mod)$coeff[1])%>%
  dplyr::select(-mod)

#write.csv(obsHanalysis,"D:/R/obsLAIanalysis.csv", row.names = FALSE)

```
###mytheme1
```{r}
mytheme1<-theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14,angle=90, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))

mytheme3<-theme(
     legend.title = element_text(colour="black", size=14, face="bold"),
     legend.text = element_text(colour="black", size = 14,face="plain"),
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14),
    legend.position = "right", legend.box = "vertical")
```
###leaf and node appearance in the same Tt before interpolate
```{r,fig.height=6, fig.width=8}
#xlab(bquote('Assimilation ('*mu~ 'mol' ~CO[2]~ m^-2~s^-1*')'))
obsLAI<-ObsLF%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_8Waterirr")

obsLAI$Rotation2<- factor(obsLAI$Rotation2, levels=c("R1", "R2", "R3", "R4", "R5","R6", "R7"))

obsLAI%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 9, by =3), limits=c(0,10))+
 #geom_point(data=obsNode, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
 facet_grid(GrowthSeason2~Rotation2)+ggtitle("E1ILL(Iversen_8Waterirr)")+mytheme1
 #ggsave("D:/R/Pictures/LAI/Iversen_8WaterirrLAI.png", width=8, height=6, dpi=500) 
```

```{r}
obsLAIL<-ObsLF%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_8Waterirr")%>%
  dplyr::filter(Observed>0)%>%
  mutate(lgLAI=log(Observed))

obsLAIL$Rotation2<- factor(obsLAIL$Rotation2, levels=c("R1", "R2", "R3", "R4", "R5","R6", "R7"))
obsLAIL%>%
  ggplot(aes(x=Tt_broken_sum, y=lgLAI))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab(bquote(bold('log LAI ('*m^2~m^-2*')')))+ 
  # scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  # scale_y_continuous(breaks = seq(0, 9, by =3), limits=c(0,10))+
 #geom_point(data=obsNode, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+
 facet_grid(GrowthSeason2~Rotation2)+ggtitle("Iversen_8Waterirr")+mytheme1

```

#Iversen_91DefoliationLL
```{r,fig.height=6, fig.width=8}
obsLAI1<-ObsL%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  dplyr::filter(Variable=="LAI")
obsLAI1$Rotation2<- factor(obsLAI1$Rotation2, levels=c("R1", "R2", "R3", "R4", "R5","R6", "R7"))

obsLAI1%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 9, by =3), limits=c(0,10))+ggtitle("E3ILL(Iversen_91DefoliationLL)")+
  #geom_point(data=obsNode1, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
 facet_grid(GrowthSeason2~Rotation2)+
  geom_smooth(method = "lm", se = TRUE,linetype=1 , colour="black")+mytheme1
 # ggsave("D:/R/Pictures/LAI/Iversen_91DefoliationLLLAI.png", width=8, height=6, dpi=500) 
```
##Iversen_9SowingDateSD1Waterirr
```{r,fig.height=4, fig.width=8}

obsLAI2<-ObsLF%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD1Waterirr")%>%
  dplyr::filter(Variable=="LAI")

obsLAI2$Rotation2<- factor(obsLAI2$Rotation2, levels=c("S1", "R1","R2", "R3", "R4", "R5","R6"))
obsLAI2%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ggtitle("E2ILLS1(Iversen_9SowingDateSD1Waterirr)")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 9, by =3), limits=c(0,10))+
  #geom_point(data=obsNode2, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
  #geom_smooth(method = "glm",family = gaussian(link="log"), aes(colour = "Exponential"))+
 facet_grid(GrowthSeason2~Rotation2)+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="black")+mytheme1
  #ggsave("D:/R/Pictures/LAI/Iversen_9SowingDateSD1WaterirrLAI.png", width=8, height=5, dpi=500) 
 
```
##Iversen_9SowingDateSD2Waterirr
```{r,fig.height=3, fig.width=8}

obsLAI3<-ObsLF%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD2Waterirr")%>%
  dplyr::filter(Variable=="LAI")
obsLAI3$Rotation2<- factor(obsLAI3$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))
 
obsLAI3%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ggtitle("E2ILLS2(Iversen_9SowingDateSD2Waterirr)")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 950, by =200), limits=c(0,950))+
  scale_y_continuous(breaks = seq(0, 9, by =3), limits=c(0,10))+
  #geom_point(data=obsNode3, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
 facet_grid(GrowthSeason2~Rotation2)+
  #geom_smooth(method = "glm",family = gaussian(link="log"), aes(colour = "Exponential"))+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="black")+mytheme3
  #ggsave("D:/R/Pictures/LAI/Iversen_9SowingDateSD2WaterirrLAI.png", width=8, height=3, dpi=500) 
 
```
##Iversen_9SowingDateSD3Waterirr
```{r,fig.height=3, fig.width=10}

obsLAI4<-ObsLF%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD3Waterirr")%>%
  dplyr::filter(Variable=="LAI")
obsLAI4$Rotation2<- factor(obsLAI4$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))

obsLAI4%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ggtitle("E2ILLS3(Iversen_9SowingDateSD3Waterirr)")+
  ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 1200, by =300), limits=c(0,1200))+
  scale_y_continuous(breaks = seq(0, 9, by =3), limits=c(0,10))+
  #geom_smooth(method = "glm",family = gaussian(link="log"), aes(colour = "Exponential"))+ 
  #geom_point(data=obsNode4, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
 facet_grid(GrowthSeason2~Rotation2)+
 geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="black")+mytheme3
 #ggsave("D:/R/Pictures/LAI/Iversen_9SowingDateSD3WaterirrLAI.png", width=8, height=3, dpi=500) 
 
 
```
##Iversen_9SowingDateSD4Waterirr
```{r,fig.height=3, fig.width=10}

obsLAI5<-ObsLF%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD4Waterirr")%>%
  dplyr::filter(Variable=="LAI")
obsLAI5$Rotation2<- factor(obsLAI5$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))

obsLAI5%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ggtitle("E2ILLS4(Iversen_9SowingDateSD4Waterirr)")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 1100, by =300), limits=c(0,1200))+
  scale_y_continuous(breaks = seq(0, 8, by =2), limits=c(0,8))+
  #geom_point(data=obsNode5, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
  facet_grid(GrowthSeason2~Rotation2)+
  #geom_smooth(method = "glm",family = gaussian(link="log"), aes(colour = "Exponential"))+  
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="black")+mytheme3
#ggsave("D:/R/Pictures/LAI/Iversen_9SowingDateSD4WaterirrLAI.png", width=8, height=3, dpi=500) 
 
```
##Iverson12DefoliationFD5
```{r,fig.height=6, fig.width=8}

obsLAI6<-ObsLF%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Variable=="LAI")
obsLAI6$Rotation2<- factor(obsLAI6$Rotation2, levels=c("S1","R1", "R2", "R3", "R4", "R5","R6"))

obsLAI6%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+
  theme_bw()+xlab("Thermal time (°Cd)")+ylab("LAI (m^2/m^2)")+ggtitle("E5ILLF5(Iversen_121DefoliationLLFDFD5)")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+ 
  scale_x_continuous(breaks = seq(0, 800, by =300), limits=c(0,800))+
  scale_y_continuous(breaks = seq(0, 10, by =4), limits=c(0,10))+
 facet_grid(GrowthSeason2~Rotation2)+
  #geom_point(data=obsNode6, aes(x=Tt_broken_sum, y=Observed),colour="green",size=3)+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="black")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+mytheme1
#ggsave("D:/R/Pictures/LAI/Iversen_121DefoliationLLFDFD5LAI.png", width=8, height=6, dpi=500) 
```
###LEAR per height

```{r}

LeafH1<-LeafH%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Tmean,Ppm,Collection,GrowthRotation,ID,ExperimentID)%>%
  do(mod = lm(LAI~Ps,data=.)) %>%
  mutate(LEAR1 = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)

phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
LEARPp1<- merge(StartGrazing1,LeafH1,by=c("Name","Collection","GrowthRotation"))


LEARPp1%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="33")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="43")%>%
  #dplyr::filter(Stage!="Seedling")%>%
  ggplot(aes(x=Tmean, y=LEAR1,label=GrowthRotation,color=Name))+geom_text()+theme_bw()+xlab("Mean photoperiod(h) ")+ylab("LEAR (m^2/m^2/°Cd)")+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="red")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  facet_grid(Trend~Stage)+
  #facet_wrap(~Stage,ncol = 2)+
  #geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())

  
```
####leaf area mutiple regression
```{r}
Leaf_Node
M.mode<-lm(LAI~Tt_broken_sum+Ppm+NodeNumber.y,data=Leaf_Node)
summary(M.mode)

LeafH
M.mode1<-lm(LAI~Tt_broken_sum+Ppm+Height.y,data=LeafH)
summary(M.mode1)

ObsL1<-ObsL%>%
   dplyr::filter(Variable=="LAI")
M.mode2<-lm(Observed~Tt_broken_sum+Ppm,data=ObsL1)
summary(M.mode2)



```

###LEAR
```{r}

LEAR<-ObsL%>%
  dplyr::filter(Variable=="LAI")%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Tmean,Ppm,Collection,GrowthRotation,ID,ExperimentID)%>%
  do(mod = lm(Observed~Tt_broken_sum,data=.)) %>%
  mutate(LEAR = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)
  
LEAR%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD2")%>%
  ggplot(aes(x=Ppm, y=LEAR, colour=factor(Name)))+geom_point(size=2)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+xlab("Photoperiod (h)")+ylab("LEAR (m^2/m^2/°Cd)")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

LAIE3ILLa<-ObsL%>%
  filter(Variable=="LAI")%>%
  filter(Rotation.x=="1")%>%
  filter(ID=="E3ILL")%>%
  filter(Tt_broken_sum<400)

LAIE3ILLa%>%
ggplot(aes(x=Pp, y=Observed, colour=factor(ID)))+geom_point(size=2)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+xlab("Tt (Cd)")+ylab("LAI (m^2/m^2)")+
  
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))

LAIE3ILLb<-ObsL%>%
  filter(Variable=="LAI")%>%
  filter(Rotation.x=="1")%>%
  filter(ID=="E3ILL")%>%
  filter(Tt_broken_sum>400)

LAIE3ILLb%>%
ggplot(aes(x=Pp, y=Observed, colour=factor(ID)))+geom_point(size=2)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+xlab("Tt (Cd)")+ylab("LAI (m^2/m^2)")+
  
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
  
modE3ILLa<-lm(LAIE3ILLa$Observed~LAIE3ILLa$Tt_broken_sum)
summary(modE3ILLa)

modE3ILLb<-lm(LAIE3ILLb$Observed~LAIE3ILLb$Tt_broken_sum)
summary(modE3ILLb)
####E2 LAER in the first rotation
LAIE2<-ObsL%>%
  filter(Variable=="LAI")%>%
  filter(ExperimentID=="E2")%>%
  filter(Rotation.x=="1")%>%
  filter(GrowthSeason.x=="2")

LAIE2%>%
ggplot(aes(x=Tt_broken_sum, y=Observed, colour=factor(ID)))+geom_point(size=2)+theme_bw()+mytheme3+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+xlab("Tt (h)")+ylab("LAI (m^2/m^2)")+
  
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
  
modE2<-lm(LAIE2$Observed~LAIE2$Tt_broken_sum)
summary(modE2)





```
#load Rotation and Growth season
```{r,fig.height=5, fig.width=10}
library(plyr)
phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
LEARPp<- merge(StartGrazing1,LEAR,by=c("Name","Collection","GrowthRotation"))


LEARPp1<-LEARPp%>%
  dplyr::filter(Collection!="2010_2012")%>%
  #dplyr::filter(Collection!="2002_2004")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="24")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="21")

lm_eqn2 <- function(LEARPp1){
  m <- lm(LEAR~Ppm , LEARPp1);
  eq <- substitute(italic(y) == Ppm + LEAR %.% italic(Ppm)*","~~italic(R)^2~"="~r2, 
                   list(Ppm = format(coef(m)[1], digits = 2), 
                        LEAR = format(coef(m)[2], digits = 2), 
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));                 
}


eqs1 <- ddply(LEARPp1,.(Trend,Stage),lm_eqn2)


LEARPp1%>%
  #dplyr::filter(Stage!="Seedling")%>%
  ggplot(aes(x=Ppm, y=LEAR,label=GrowthRotation,color=ID))+geom_text()+theme_bw()+
  xlab("Mean photoperiod (h) ")+ylab(bquote(bold('LAER ('*m^2~m^-2~'°Cd'^-1*')')))+ 
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  facet_grid(Trend~Stage)+
  geom_text(data = eqs1, aes(y =0.03, x = 13.5, label = V1), 
          color = 'black',  parse = TRUE)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())+mytheme3
 detach(package:plyr)
  ggsave("D:/R/Pictures/LAI/LEARPP.png", width=8.5, height=6, dpi=500) 
```

```{r}
LEARPpd<-LEARPp1%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(Trend=="Dec")
mod<-lm(LEARPpd$LEAR~LEARPpd$Ppm)
summary(mod)

LEARPpI<-LEARPp1%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(Trend=="Inc")
mod1<-lm(LEARPpI$LEAR~LEARPpI$Ppm)
summary(mod1)
```


```{r}
LEARPp1<-LEARPp%>%
dplyr::filter(Stage!="Seedling")

X<-LEARPp1$Ppm
Y<-LEARPp1$LEAR
Xsq<-X^2
Xcub<-X^3
plot(X,Y, pch=19)
model1<-lm(Y~X)
model2<-lm(Y~X+Xsq)
model3<-lm(Y~X+Xsq+Xcub)

anova(model1)
summary(model1)
anova(model2)
summary(model2)
anova(model3)
summary(model3)
abline(model1, col="red")
XV<-seq(min(X),max(X),0.01)
yv<-predict(model2,list(X=XV,Xsq=XV^2))
lines(XV,yv,col="blue")
  
```

####Sen
```{r,fig.height=6, fig.width=10}
ObsLSen<-ObsL.Raw%>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(Variable=="Senescence"|Variable=="NodeNumber")%>%
  dplyr::filter(Tbb==1)
ObsSen<-ObsLSen%>%
  dplyr::filter(Variable=="Senescence")%>%
  dplyr::select(Clock.Today,Name,Collection,GrowthSeason.x,Rotation.x,Variable,Observed,StdDEV,Tt_broken_sum,Ppm,Tmean,GrowthRotation)
ObsNode<-ObsLSen%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::select(Clock.Today,Name,Collection,GrowthSeason.x,Rotation.x,Variable,Observed,StdDEV,Tt_broken_sum,Ppm,Tmean,GrowthRotation)
ObsSen_Node<-merge(ObsSen,ObsNode,by=c("Clock.Today","Name","Collection","GrowthSeason.x","Rotation.x","Tt_broken_sum","Ppm","Tmean","GrowthRotation"))
ObsSen_Node%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  ggplot(aes(x=Observed.y, y=Observed.x,label=GrowthRotation))+theme_bw()+xlab("NodeNumber")+ylab("Senescence")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
   facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Stage,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
  
  
```

```{r}
ObsSen_Node%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Tt_broken_sum>200)%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed.x,label=GrowthRotation))+theme_bw()+ylab("Senescence")+xlab("Thermal time")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
   facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Stage,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())

```
```{r}
ObsSN.rate<-ObsSen_Node%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,GrowthRotation) %>%
  do(mod = lm(Observed.x~Observed.y,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)

phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
ObsSNPp<- merge(StartGrazing1,ObsSN.rate,by=c("Name","Collection","GrowthRotation"))
ObsSNPp%>%
  dplyr::filter(Name!="Iversen_91DefoliationLL")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="13")%>%
  dplyr::filter(Name!="Iversen_121DefoliationLLFDFD5"|GrowthRotation!="31")%>%
  ggplot(aes(x=Ppm, y=slope,label=GrowthRotation,color=Name))+theme_bw()+xlab("Photoperiod")+ylab("Senescence rate")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
   #facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Trend,ncol = 2)+
  #geom_point(size=2)+
  geom_text()+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())

```
```{r}
ObsST.rate<-ObsSen_Node%>%
  dplyr::filter(Tt_broken_sum>200)%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,GrowthRotation) %>%
  do(mod = lm(Tt_broken_sum~Observed.x,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)

phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
ObsSTPp<- merge(StartGrazing1,ObsST.rate,by=c("Name","Collection","GrowthRotation"))
ObsSTPp%>%
  dplyr::filter(Name!="Iversen_91DefoliationLL"|GrowthRotation!="16")%>%
  dplyr::filter(Name!="Iversen_91DefoliationLL"|GrowthRotation!="27")%>%
  dplyr::filter(Name!="Iversen_91DefoliationLL"|GrowthSeason.x!="1")%>%
  ggplot(aes(x=Ppm, y=slope,label=GrowthRotation,color=Name))+theme_bw()+xlab("Photoperiod")+ylab("Sen per node")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
   #facet_grid(GrowthSeason.x~Rotation.x)+
  facet_wrap(~Trend,ncol = 2)+
  #geom_point(size=2)+
  geom_text()+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())

```


```{r,fig.height=6, fig.width=10}
ObsSen_Node%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")%>%
  ggplot(aes(x=Observed.y, y=Observed.x,label=GrowthRotation))+theme_bw()+xlab("NodeNumber")+ylab("Senescence")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
   facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Stage,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
```


####Braching
```{r,fig.height=6, fig.width=10}
ObsLbranch<-ObsL.Raw%>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(Variable=="Branch"|Variable=="NodeNumber")%>%
  dplyr::filter(Tbb==1)
Obsbranch<-ObsLbranch%>%
  dplyr::filter(Variable=="Branch")%>%
  dplyr::select(Clock.Today,Name,Collection,GrowthSeason.x,Rotation.x,Variable,Observed,StdDEV,Tt_broken_sum,Ppm,Tmean,GrowthRotation)
ObsNode<-ObsLbranch%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::select(Clock.Today,Name,Collection,GrowthSeason.x,Rotation.x,Variable,Observed,StdDEV,Tt_broken_sum,Ppm,Tmean,GrowthRotation)
ObsBr_Node<-merge(Obsbranch,ObsNode,by=c("Clock.Today","Name","Collection","GrowthSeason.x","Rotation.x","Tt_broken_sum","Ppm","Tmean","GrowthRotation"))
ObsBr_Node%>%
  #dplyr::filter(Observed.y>4)%>%
  ggplot(aes(x=Observed.y, y=Observed.x,label=GrowthRotation))+geom_point()+theme_bw()+xlab("NodeNumber")+ylab("Branch")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Stage,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
  
  
```
###Branching data prepare for interpolate with LAI
```{r,fig.height=6, fig.width=10}
ObsLBL<-ObsL.Raw%>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(Variable=="Branch"|Variable=="LAI")%>%
  dplyr::filter(Tbb==1)%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Clock.Today<"2016-07-01")%>%
  dplyr::filter(GrowthRotation!="14")
  
```
###Branching interpolate for each rotation
```{r}

# add function to "turn-off" rowise() in dplyr. FIXME: maybe there's a better/simpler solution?

UniExp <- unique(ObsLBL$ExpUnitCode)

InteBL.df<- data.frame()
  
for(i in 1:length(UniExp))
{
  
  ObsLBL.sub<-ObsLBL%>%
   filter(ExpUnitCode==UniExp[i])
  
 LB<- ObsLBL.sub%>%
  unique()%>%
  tidyr::spread(Variable,Observed)
 
 LB.data<-LB%>%
  mutate( Branch.y=approx(LB$Clock.Today, LB$Branch, xout =LB$Clock.Today, 
         method="linear", 
         rule = 2)$y)##interpolate function 
  

 InteBL.df <- rbind(InteBL.df, LB.data)

}

summary(InteBL.df)
InteBL.df
#write.csv(df.all,"D:/R/TtAll/df.all.csv", row.names = FALSE)

```
##Branch against LAI
```{r}
InteBL.df%>%
  dplyr::filter(GrowthRotation!="11")%>%
  ggplot(aes(x=Branch.y, y=LAI,label=GrowthRotation))+theme_bw()+ylab("LAI")+xlab("Branch")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  #facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Stage,ncol = 2)+
  geom_text()+
  #geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
```

###Branching per node in Increase and decrease photoperiods

```{r}
ObsBr.rate<-ObsBr_Node%>%
   dplyr::filter(Observed.y>4)%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,GrowthRotation) %>%
  do(mod = lm(Observed.x~Observed.y,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)

phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
ObsBrPp<- merge(StartGrazing1,ObsBr.rate,by=c("Name","Collection","GrowthRotation"))

ObsBrPp%>%
  dplyr::filter(GrowthRotation!="26")%>%
  dplyr::filter(GrowthRotation!="36")%>%
  # dplyr::filter(GrowthRotation!="24")%>%
  # dplyr::filter(GrowthRotation!="34")%>%
  ggplot(aes(x=Tmean, y=slope,label=GrowthRotation))+geom_text()+theme_bw()+ylab("Branch per node")+xlab("Mean temperature")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  #facet_grid(GrowthSeason.x~Rotation.x)+
  facet_wrap(~Trend,ncol = 2)+
  #geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())


```
###shoot population number
```{r}
ObsSP<-ObsL.Raw %>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(FD.x=="FD5")%>%
  dplyr::filter(Tbb==1)%>%
  dplyr::filter(Variable=="ShootPopulation"|Variable=="LAI")%>%
  dplyr::filter(Name!="Iversen_8Waterirr")%>%
  dplyr::filter(Collection=="2002_2004")%>%
  dplyr::filter(Name!="Iversen_91DefoliationLL"|GrowthRotation!="31")
  
  


UniExp <- unique(ObsSP$ExpUnitCode)

InteSP.df<- data.frame()
  
for(i in 1:length(UniExp))
{
  
  ObsLSP.sub<-ObsSP%>%
   filter(ExpUnitCode==UniExp[i])
  
 LSP<- ObsLSP.sub%>%
  unique()%>%
  tidyr::spread(Variable,Observed)
 
 LSP.data<-LSP%>%
  mutate( ShootPopulation.y=approx(LSP$Clock.Today, LSP$ShootPopulation, xout =LSP$Clock.Today, 
         method="linear", 
         rule = 2)$y)##interpolate function 
  

 InteSP.df <- rbind(InteSP.df, LSP.data)

}

summary(InteSP.df)
InteSP.df
  
```


```{r}
InteSP.df%>%
   ggplot(aes(y=ShootPopulation.y, x=LAI,label=GrowthRotation))+theme_bw()+ylab("Shoot    population")+xlab("LAI")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  #facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Trend,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
```


###Plant population 
```{r}
ObsSP<-ObsL.Raw %>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(FD.x=="FD5")%>%
  dplyr::filter(Tbb==1)%>%
  dplyr::filter(Variable=="PlantPopulation")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")
ObsSP%>%
   ggplot(aes(x=Tt_broken_sum, y=Observed,label=GrowthRotation))+theme_bw()+ylab("Plant population")+xlab("Thermal time")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Trend,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())



```

###Branching against thermal time

```{r}
ObsBr_Node%>%
  dplyr::filter(Observed.y>4)%>%
  ggplot(aes(x=Tt_broken_sum, y=Observed.x,label=GrowthRotation))+geom_point()+theme_bw()+ylab("Branch")+xlab("Thermal time")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Stage,ncol = 2)+
  geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
```

###branchchron aganist Photoperiod
```{r}
ObsBT.rate<-ObsBr_Node%>%
   dplyr::filter(Observed.y>4)%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,GrowthRotation) %>%
  do(mod = lm(Tt_broken_sum~Observed.x,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)

phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
ObsBTPp<- merge(StartGrazing1,ObsBT.rate,by=c("Name","Collection","GrowthRotation"))


ObsBTPp%>%
  dplyr::filter(GrowthRotation!="26")%>%
  dplyr::filter(GrowthRotation!="36")%>%
  dplyr::filter(GrowthRotation!="24")%>%
  dplyr::filter(GrowthRotation!="34")%>%
  ggplot(aes(x=Ppm, y=slope,label=GrowthRotation))+geom_text()+theme_bw()+ylab("Branchchron")+xlab("photoperiod")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  #facet_grid(GrowthSeason.x~Rotation.x)+
  facet_wrap(~Trend,ncol = 2)+
  #geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
  
```
###Node number against branching

```{r}
ObsBN.rate<-ObsBr_Node%>%
  dplyr::filter(Observed.y>5)%>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,GrowthRotation) %>%
  do(mod = lm(Observed.x~Observed.y,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
  dplyr::select(-mod)
ObsBN.rate%>%
  ggplot(aes(x=Tmean, y=slope,label=GrowthRotation))+geom_text()+theme_bw()+xlab("NodeNumber")+ylab("Branch")+
  #geom_smooth(method = "lm", se = TRUE, formula=y ~ poly(x, 2, raw=TRUE), colour="darkgrey")+
  #facet_grid(GrowthSeason.x~Rotation.x)+
  #facet_wrap(~Trend,ncol = 2)+
  #geom_point(size=2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))+
  theme(legend.title=element_blank())
  
```

###log trasmission of LAI
###resdule plots
###example
```{r}
eruption.lm = lm(eruptions ~ waiting, data=faithful) 
eruption.res = resid(eruption.lm)
#We now plot the residual against the observed values of the variable waiting.

plot(faithful$waiting, eruption.res, 
 ylab="Residuals", xlab="Waiting Time", main="Old Faithful Eruptions") 
 abline(0, 0)                  # the horizon
```
##Lai trassion
```{r}
logLAI<-ObsL%>%
  dplyr::filter(Variable=="LAI")
logLAI.lm <-lm(logLAI$Observed ~ logLAI$Tt_broken_sum)
summary(logLAI.lm)
plot(logLAI.lm)

```
```{r}
logLAI1<-logLAI%>%
  dplyr::filter(Observed>0)%>%
  mutate(lgLAI=log(Observed))
a<-lm(lgLAI ~Tt_broken_sum ,data=logLAI1)
summary(a)
plot(a)

```
###transformaing for seedling crop

```{r}
logLAIS<-logLAI%>%
  dplyr::filter(Observed>0)%>%
  dplyr::filter(Name!="Iversen_8Waterirr")%>%
dplyr::filter(Name!="Iversen_91DefoliationLL")%>%
  dplyr::filter(GrowthRotation=="11")%>%
  mutate(lgLAI=log(Observed))
A<-lm(lgLAI ~Tt_broken_sum ,data=logLAIS)
summary(A)
plot(A)
```
###untransformaing for seedling crop
```{r}
logLAIS1<-logLAI%>%
  dplyr::filter(Observed>0)%>%
  dplyr::filter(Name!="Iversen_8Waterirr")%>%
dplyr::filter(Name!="Iversen_91DefoliationLL")%>%
  dplyr::filter(GrowthRotation=="11")
S<-lm(Observed ~Tt_broken_sum ,data=logLAIS1)
summary(S)
plot(S)
```

## Define stats function

* Using Gauch et al. 2003 (Model evaluation by comparison of model-based predictions and measured values. Agron. J. 95, 1442-1446) 
```{r Stats, include = TRUE, echo=FALSE, warning=FALSE, fig.height=8, fig.width=8}

# # R2
# testDF <- data.frame(a=c(1,2,3,4,5), b=c(10,20,10,40,50))
# 
# myR2 <- function(p,o) {
#  return(summary(lm(p~o, na.action=na.exclude))$r.squared) 
# }
# 
# testDF %>%
#   summarise(thisR2 = myR2(a,b))

# gauch MSE components
gauchStats <- function(sim, meas) {

  n_s <- length(sim)
  n_m <- length(meas)
  model <- lm(meas~sim)
  sim_sq <- sum((sim - mean(sim))^2)
  mes_sq <- sum((meas - mean(meas))^2)
  r2 <- summary(model)$r.squared
  slope <- model$coefficients[[2]]

  sb <- (sum(mean(meas)) - sum(mean(sim)))^2
  nu <- (1-slope)^2 * (sim_sq/n_s)
  lc <- (1-r2) * (mes_sq/n_m)
  msd <- sb+nu+lc

  sb_r <- round((sb/msd)*100,1)
  nu_r <- round((nu/msd)*100,1)
  lc_r <- round((lc/msd)*100,1)

  msd_r <- sb_r+nu_r+lc_r

  # select which variables to output
  out <- c(sb_r,nu_r,lc_r, msd_r, round(r2*100,1))

  return(out)

}
```

## Test stats functions used

```{r}
s <- c(4231.972,3935.604,3779.652,3627.687,3363.499,3230.566,2868.114,2868.827)
m <- c(4987.66,5636.09,4754.06,4114.53,4141.72,3704.06,5142.19,4762.03)

x <- gauchStats(s,m)

tempDf <- data.frame(statName=c("SB","NU","LC","r_MSD","R2"), statValue=x)
# kable(tempDf, digits= 2)
tempDf2 <- data.frame(Predicted=s, Observed=m)

x <- tempDf2 %>%
  summarise(
    n = n(),
    r2 = gauchStats(Predicted,Observed)[5],
  #  rmse = round(rmse(Predicted,Observed),0),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,1),
    nse = round(NSE(Predicted,Observed),1),
    sb = gauchStats(Predicted,Observed)[1],
  nu = gauchStats(Predicted,Observed)[2],
  lc = gauchStats(Predicted,Observed)[3]
  ) %>% 
  t() 

df <- data.frame(stat = row.names(x),statvalue = x[,1])

df %>%
  kable(format = "markdown")
```
## Load simulated database
## create function to read data (Justin's script)
```{r LoadSim, include = FALSE, echo=FALSE, warning=FALSE, fig.height=8, fig.width=8}
GetApsimNGTable <- function(dbLoc, table) 
{
  connection <- dbConnect(SQLite(), dbname = dbLoc, flags = SQLITE_RW)
  table <- dbReadTable(connection, table, row.names=NULL)
  dbDisconnect(connection)
  return(table)
}

```
# load address of db
# set table to be enquierd
# load table into an object
# make it a dataframe
# change date to corerct format 
# explore the df
```{r}
db.address <- "D:\\APSIMX2\\Prototypes\\Lucerne\\LucerneValidation.db"
tableName<-"Report"
DbTable <- GetApsimNGTable(db.address,tableName)
df <- as.data.frame(DbTable)
df$Clock.Today <- ymd_hms(df$Clock.Today)
str(df)
summary(df)
head(df) # simulation results
```
# get sim names (different table)
# merge names 
# remove unecessary variables
```{r}
simNameDf <- as.data.frame (GetApsimNGTable(db.address,"_Simulations"))
myDb <- merge(df, simNameDf, by.x= c("SimulationID"), by.y= c("ID"))


#str(myDb)
head(myDb)
summary(myDb)

# myDb %>%
#   dplyr::select(Name) %>%
#   unique()

```
## Prepare merge
## Add info for merging
## select variables that are for comparing with observed data

```{r}
simD <- myDb %>%
  dplyr::select(Name,Clock.Today,LAI,Height,shootbiomass,RootWt, StemWt, LeafWt,NodeNumber) %>%
  tidyr::gather("Variable","Predicted",LAI:NodeNumber) %>%
  mutate(Name = as.factor(Name)) %>%
  mutate(Variable = as.factor(Variable)) %>%
  mutate(Clock.Today = ymd_hms(Clock.Today))

head(simD)
summary(simD)



mergedf<-merge(ObsL,simD,by=c("Clock.Today","Name","Variable"))
summary(mergedf)
str(mergedf)
mergedf

```
## Node number
#Time series
## obs Vs Pre for each experiment
## 1997-2001
```{r,fig.height=4, fig.width=8}

obsLAI1<-ObsL%>%
  dplyr::filter(Collection=="1997_2001")%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_8Waterirr")%>%
  dplyr::filter(Clock.Today>"1996-08-01")%>%
  dplyr::filter(Clock.Today<"2001-08-01")
   
 simD1<-simD%>%
   mutate(Clock.Today = ymd_hms(Clock.Today))%>%
   dplyr::filter(Clock.Today>"1996-08-01")%>%
   dplyr::filter(Clock.Today<"2001-08-01")%>%
   dplyr::filter(Variable=="LAI")%>%
   dplyr::filter(Name=="Iversen_8Waterirr")
 str(simD1)
 simD1%>%
 ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
 facet_wrap(~ID,ncol = 2)+
   mytheme3+
 annotate("text", x=ymd_hms("1999-10-24 12:00:00"), y=8, size = 5, label ="paste(R_RMSD == 52.5,'%')", parse=T)+
   #geom_text(aes(x=ymd_hms("1999-10-24 12:00:00"), y=750, label="R_RMSD = 37.6%",size=5))
 geom_point(data=obsLAI1, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
 theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))
 
 ggsave("D:/R/Pictures/LAI/Iversen_8WaterirrLAI1.png", width=8, height=4, dpi=500)

```
##2002-2004
```{r,  fig.height=4, fig.width=8}
obsLAI2<-ObsL%>% 
  dplyr::filter(Collection=="2002_2004")%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")

simD2<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Clock.Today>"2002-06-01")%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")
str(simD2)

simD2%>%
ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
  facet_wrap(~ID,ncol = 1)+
  geom_point(data=obsLAI2, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+
   mytheme3+
 annotate("text", x=ymd_hms("2003-07-24 12:00:00"), y=8, size = 5, label ="paste(R_RMSD == 43.2,'%')", parse=T)
ggsave("D:/R/Pictures/LAI/Iversen_91DefoliationLLLAI1.png", width=8, height=4, dpi=500)
```

```{r,  fig.height=8, fig.width=8}
obsLAI3<-ObsL%>%
  dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Variable=="LAI")
 

simD3b<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Clock.Today>"2000-10-24 12:00:00")%>%
  dplyr::filter(Clock.Today<"2002-07-01 12:00:00")%>%
  dplyr::filter(Name==c("Iversen_9SowingDateSD1Waterirr","Iversen_9SowingDateSD2Waterirr","Iversen_9SowingDateSD3Waterirr","Iversen_9SowingDateSD4Waterirr"))%>%
  dplyr::filter(Variable=="LAI")
DF<-data.frame(Name=c("Iversen_9SowingDateSD1Waterirr","Iversen_9SowingDateSD2Waterirr","Iversen_9SowingDateSD3Waterirr","Iversen_9SowingDateSD4Waterirr"),ID= c("E2ILLS1","E2ILLS2","E2ILLS3","E2ILLS4"))
simD3<-merge(DF,simD3b, by=c("Name"))
 
p1<-simD3%>%
ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
  facet_wrap(~ID,ncol = 2)+
  geom_point(data=obsLAI3, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+
  mytheme3

p1


dat_text1 <- data.frame(
  label = c("R_RMSE=34.4%","R_RMSE=45.9%","R_RMSE=31.5%", "R_RMSE=52.2%"),
  ID= c("E2ILLS1","E2ILLS2","E2ILLS3","E2ILLS4"),
  x= ymd_hms("2001-01-24 12:00:00", "2001-01-24 12:00:00","2001-01-24 12:00:00","2001-01-24 12:00:00"),
  y=c(9,9,9,9)) 

 p1   +geom_text(data=dat_text1, mapping = aes(x=x,y=y, label = label),hjust   = -0.1,vjust   = -1,size=5)+
   scale_y_continuous(breaks = seq(0, 9, by =2), limits=c(0,10))
 
ggsave("D:/R/Pictures/LAI/Iversen_9SowingDateLAI1.png", width=8, height=8, dpi=500)
  
```
##2014-2018
```{r,  fig.height=4, fig.width=8}
obsLAI4<-ObsL%>% 
  dplyr::filter(Collection=="2014_2018")%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")

simD4a<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Clock.Today<"2015-01-06")

simD4b<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Variable=="LAI")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Clock.Today>"2015-01-30")

simD4<-rbind(simD4a,simD4b)

simD4%>%
ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
  facet_wrap(~ID,ncol = 1)+
  geom_point(data=obsLAI4, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab(bquote(bold('LAI ('*m^2~m^-2*')')))+
   mytheme3+
annotate("text", x=ymd_hms("2016-07-24 12:00:00"), y=9.5, size = 5, label ="paste(R_RMSD == 52.4,'%')", parse=T)

ggsave("D:/R/Pictures/LAI/Iversen_121DefoliationLLFDFD5LAI1.png", width=8, height=4, dpi=500)

```


# Statistic and Graph
```{r,,fig.height=6, fig.width=8}
mergedf
summary(mergedf)
str(mergedf)

mergedf %>%
    dplyr::filter(Variable== "LAI") %>% 
  dplyr::filter(Clock.Today>"1997-08-01")%>%
  dplyr::filter(Defoliation.x== "LL")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  ggplot(aes(x=Observed, y= Predicted, colour= factor(Name),label=GrowthRotation)) +
  geom_point(size=2)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1)+
  ggtitle("LAI")+mytheme3+
  facet_wrap(~ID, ncol = 4)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Observed")+ylab("Predicted")
ggsave("D:/R/Pictures/LAI/predicted1.png", width=8, height=6, dpi=500)

```

## RMSE

```{r}
str(mergedf)

mergedf %>%
  dplyr::filter(Clock.Today>"1997-08-01")%>%
  dplyr::filter(Variable== "LAI") %>% 
   dplyr::filter(Water.x== "irr")%>%
  dplyr::filter(Defoliation.x== "LL")%>%
 #filter(Variable == "NodeNumber") %>%
  filter(Collection!="2010_2012")%>%
  mutate(Rotation= as.factor(Rotation.x))%>%
  mutate(GrowthSeason=as.factor(GrowthSeason.x))%>%
  group_by(ID) %>%
  summarise(
    n = n(),
    r2 = gauchStats(Predicted,Observed)[5],
  #  rmse = round(rmse(Predicted,Observed),0),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,1),
    nse = round(NSE(Predicted,Observed),2),
    sb = gauchStats(Predicted,Observed)[1],
  nu = gauchStats(Predicted,Observed)[2],
  lc = gauchStats(Predicted,Observed)[3]
  ) 

  
```

