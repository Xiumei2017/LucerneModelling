---
title: "R Notebook"
output: html_notebook
---
###NodeNumber analysis

```{r Load, warning=FALSE, fig.height=8, fig.width=8}

library(plyr)
library(dplyr)
library(ggplot2)
library(lubridate)   
library(hydroGOF)
library(xtable)
library(knitr)
library(tidyr)
library(RSQLite)
library(agricolae)
library(scales)
library(zoo)

detach(package:plyr)
```

# ### load obs data
```{r}
upDir <- "D:/R/CombinedData/"
obsData <- "D:/R/CombinedData/"

obsAll <- read.table(paste0(obsData, "ObsAll.txt"),
                   header = TRUE)
obsA1<- obsAll %>%
  dplyr::filter(Collection=="2000_2002")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
 mutate(Rotation2=as.factor(ifelse(Rotation=="1",paste0("S",Rotation),paste0("R",Rotation))))

obsA4<- obsAll %>%
  dplyr::filter(Collection=="2014_2018")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
  mutate(Rotation2=as.factor(ifelse(Rotation=="1",paste0("S",Rotation),paste0("R",Rotation))))
 

  obsA2<- obsAll %>%
  dplyr::filter(Collection=="1997_2001")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
  mutate(Rotation2=as.factor(paste0("R",Rotation)))
  

  obsA3<- obsAll %>%
  dplyr::filter(Collection=="2002_2004")%>%
  mutate(StartDate=dmy(StartDate),MidDate=dmy(MidDate),FinishDate=dmy(FinishDate),Clock.Today=dmy(Clock.Today)) %>%
  #mutate(SowingDate=as.factor(ifelse(SowingDate=="no","Sd_No",paste0("Sd_",SowingDate)))) %>% # assume this is typo to be fixed?
  mutate(GrowthSeason1=as.factor(paste0("Gs_",GrowthSeason))) %>% # creating more intuitive labels here
  mutate(Rotation1=as.factor(paste0("Rt_",Rotation))) %>%
  mutate(ExpUnitCode=as.factor(paste0(Name,GrowthSeason1,Rotation1))) %>%
  mutate(Clock.Today1 = as.POSIXct(paste(Clock.Today,Time),format="%Y-%m-%d %H:%M:%S"))%>%
  mutate(GrowthSeason2=as.factor(paste0("Y",GrowthSeason,"(",Period,")"))) %>%
  mutate(Rotation2=as.factor(paste0("R",Rotation)))
  
obsA<-rbind(obsA2,obsA3,obsA1,obsA4)
summary(obsA)
 obsA
```
```{r}
upDir <- "D:/R/"
obsData <- "D:/R/TtAll/"

Tt<- read.table(paste0(obsData, "df.all.txt"),
               header = TRUE)
TtA <- Tt %>% mutate(Clock.Today=dmy(Clock.Today), ExpUnitCode=as.factor(ExpName))
TtA
ObsH <-merge(obsA,TtA,by=c("Clock.Today","ExpUnitCode")) %>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))%>%
  dplyr::filter(Water.x=="irr")%>%
  dplyr::filter(Defoliation.x=="LL")%>%
  dplyr::filter(Variable=="NodeNumber")
  summary(ObsH)

```
```{r}
mytheme1<-theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14,angle=90, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))

mytheme3<-theme(
     legend.title = element_text(colour="black", size=14, face="bold"),
     legend.text = element_text(colour="black", size = 14,face="plain"),
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14),
    legend.position = "right", legend.box = "vertical")
```

###Examples for order text 
```{r}

x1 <- c("white","white","blue","green","red","blue","red")
 ord <- c("red","white","blue","green")
 f1 <- factor(x1,levels=ord)
 sort(f1)
x2 <- as.character(sort(f1))

x <- c("white","white","blue","green","red","blue","red")
y <- c("red","white","blue","green")
x[order(match(x, y))]


```

```{r,fig.height=6, fig.width=8}
obsNode<-ObsH%>%
  dplyr::filter(Tbb==1)

  obsNode0<-obsNode%>%
  dplyr::filter(Name=="Iversen_8Waterirr")
  obsNode0$Rotation2<- factor(obsNode0$Rotation2, levels=c("R1", "R2", "R3", "R4", "R5","R6", "R7"))
  obsNode0%>%  
  ggplot(aes(x=Tt_broken_sum, y=Observed))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd) ")+ylab("Node number")+ggtitle(paste0("E1ILL","(Iversen_8Waterirr)"))  +
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 18, by =6), limits=c(0,16))+
 geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
 facet_grid(GrowthSeason2~Rotation2)+mytheme1
#to save a final graph 
#ggsave("D:/R/Pictures/Node/Iversen_8Waterirrnode.png", width=8, height=6, dpi=500)

```

```{r}
#fig.height=4, fig.width=8
obsNode1<-obsNode%>%
  #dplyr::filter(Ture!="No")%>%
  dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD1Waterirr")
obsNode1$Rotation2<- factor(obsNode1$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))
obsNode1%>%
  ggplot(aes(x=Tt_beta_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd) ")+scale_x_continuous(limits=c(0,425))+
  ylab("Node number")+ggtitle(paste0("E2ILLS1","(Iversen_9SowingDateSD1Waterirr)"))+
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 18, by =6), limits=c(0,16))+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
 facet_grid(GrowthSeason2~Rotation2)+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 14))+mytheme1
  #ggsave("D:/R/Pictures/Node/Iversen_9SowingDateSD1Waterirrnode.png", width=8, height=4, dpi=500)
   
```

```{r,fig.height=3, fig.width=10}
obsNode2<-obsNode%>%
  #dplyr::filter(Ture!="No")%>%
  dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD2Waterirr")
obsNode2$Rotation2<- factor(obsNode2$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))
obsNode2%>%
  ggplot(aes(x=Tt_beta_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab("Node number")+ggtitle(paste0("E2ILLS2","(Iversen_9SowingDateSD2Waterirr)"))+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
 facet_grid(GrowthSeason2~Rotation2)+
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 18, by =6), limits=c(0,16))+
#remove grid lines 
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))
   #ggsave("D:/R/Pictures/Node/Iversen_9SowingDateSD2Waterirrnode.png", width=8, height=3, dpi=500)
  
```

```{r,fig.height=3, fig.width=10}
obsNode1<-obsNode%>%
  #dplyr::filter(Ture!="No")%>%
  dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD3Waterirr")
obsNode1$Rotation2<- factor(obsNode1$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))
obsNode1%>%
  ggplot(aes(x=Tt_beta_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab("Node number")+ggtitle("E2ILLS3(Iversen_9SowingDateSD3Waterirr)")+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
 facet_grid(GrowthSeason2~Rotation2)+theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 14))+
  #remove grid lines 
   theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))
   #ggsave("D:/R/Pictures/Node/Iversen_9SowingDateSD3Waterirrnode.png", width=8, height=3, dpi=500)
  
```
```{r,fig.height=3, fig.width=10}
obsNode1<-obsNode%>%
  #dplyr::filter(Ture!="No")%>%
  dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Name=="Iversen_9SowingDateSD4Waterirr")
obsNode1$Rotation2<- factor(obsNode1$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6"))
obsNode1%>%
  ggplot(aes(x=Tt_beta_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab("Node number")+ggtitle("E2ILLS4(Iversen_9SowingDateSD4Waterirr)")+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
 facet_grid(GrowthSeason2~Rotation2)+theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
  #remove grid lines 
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))
   #ggsave("D:/R/Pictures/Node/Iversen_9SowingDateSD4Waterirrnode.png", width=8, height=3, dpi=500)
  
```


```{r,fig.height=6, fig.width=8}
obsNode4<-obsNode%>%
  #dplyr::filter(Ture!="No")%>%  
  dplyr::filter(Name=="Iversen_91DefoliationLL")
obsNode4$Rotation2<- factor(obsNode4$Rotation2, levels=c("R1", "R2", "R3", "R4", "R5","R6","R7")) 

obsNode4%>%
ggplot(aes(x=Tt_beta_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+ylab("Node number")+
  ggtitle("E3ILL(Iversen_91DefoliationLL)")+
  scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 18, by =6), limits=c(0,16))+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
 facet_grid(GrowthSeason2~Rotation2)+
  mytheme1
  #ggsave("D:/R/Pictures/Node/Iversen_91DefoliationLLnode.png", width=8, height=5, dpi=500)
 # ggsave("D:/R/Pictures/Poster/nodenumberE3.png", width=8, height=4, dpi=500)
```

```{r,fig.height=6, fig.width=8}
obsNodeLL<-obsNode%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")
obsNodeLL$Rotation2<- factor(obsNodeLL$Rotation2, levels=c("S1", "R2", "R3", "R4", "R5","R6","R7")) 

obsNodeLL%>%
  ggplot(aes(x=Tt_beta_sum, y=Observed), colour=factor(Name))+geom_point(size=2)+theme_bw()+xlab("Thermal time (°Cd)")+scale_x_continuous(limits=c(0,430))+
  ylab("Node number")+ggtitle("E5ILLF5(Iverson_121DefoliationLLFDFD5)")+
 geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="blue")+
   scale_x_continuous(breaks = seq(0, 550, by =200), limits=c(0,450))+
  scale_y_continuous(breaks = seq(0, 18, by =6), limits=c(0,16))+
 facet_grid(GrowthSeason2~Rotation2)+
   mytheme1
  # ggsave("D:/R/Pictures/Node/Iversen_121DefoliationLLFDFD5node.png", width=8, height=6, dpi=500)

```

###R squared and phyllo calculation for each rotation
##TTWES1
##Tb evaluation 
```{r}
#obsef1%>%
 # dplyr::filter(Ture!="No")
 # statWE1<-ObsH%>%
 # filter(Variable == "NodeNumber") %>%
 #  filter(Water=="irr")%>%
 #  filter(Defoliation=="LL")%>%
 #  mutate(GrowthSeason=factor(GrowthSeason))%>%
 #  group_by(GrowthSeason,Collection) %>%

uniTb <- unique(ObsH$Tbb)

PhyBeta.all <- data.frame()
 
for(i in 1:length(uniTb)){
  
  ObsH1 <- ObsH %>%
  filter(Tbb==uniTb[i])
  
   ObsH.sub <- ObsH1 %>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,Tbb,ID,ExperimentID) %>%
    do(mod.beta = lm(Tt_beta_sum~Observed,data=.))%>%
  mutate(R2WE = summary(mod.beta)$r.squared)%>%
  mutate(PhylloWE = summary(mod.beta)$coeff[2])%>%
  dplyr::select(-mod.beta)

  PhyBeta.all <- rbind(PhyBeta.all, ObsH.sub)
}
  
PhyBeta.all
write.csv(PhyBeta.all,"D:/R/PhyllochronData/PhyBeta.all.csv", row.names = FALSE)

```
```{r}
uniTb <- unique(ObsH$Tbb)

Phybroken.all <- data.frame()
 
for(i in 1:length(uniTb)){
  
  ObsH1 <- ObsH %>%
  filter(Tbb==uniTb[i])
  
   ObsH.sub <- ObsH1 %>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,Tbb,ID,ExperimentID) %>%
    do(mod.broken = lm(Tt_broken_sum~Observed,data=.))%>%
    #do(mod.fick = lm(Tt_fick_sum~Observed,data=.))%>%
  mutate(R2Br = summary(mod.broken)$r.squared)%>%
  mutate(PhylloBr = summary(mod.broken)$coeff[2])%>%
  mutate(P=anova(mod.broken)$'Pr(>F)'[1])%>% 
  mutate(intcp= summary(mod.broken)$coeff[1])%>%  
  dplyr::select(-mod.broken)

  Phybroken.all <- rbind(Phybroken.all, ObsH.sub)
}
  
Phybroken.all
write.csv(Phybroken.all,"D:/R/PhyllochronData/Phybroken.all.csv", row.names = FALSE)
```

```{r}
uniTb <- unique(ObsH$Tbb)

Phyfick.all <- data.frame()
 
for(i in 1:length(uniTb)){
  
  ObsH1 <- ObsH %>%
  filter(Tbb==uniTb[i])
  
   ObsH.sub <- ObsH1 %>%
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,Tbb,ID,ExperimentID) %>%
    do(mod.fick = lm(Tt_fick_sum~Observed,data=.))%>%
  mutate(R2fi = summary(mod.fick)$r.squared)%>%
  mutate(Phyllofick = summary(mod.fick)$coeff[2])%>%
  dplyr::select(-mod.fick)

  Phyfick.all <- rbind(Phyfick.all, ObsH.sub)
}
  
Phyfick.all
write.csv(Phyfick.all,"D:/R/PhyllochronData/Phyfick.all.csv", row.names = FALSE)
```


<!-- ##TTWES2 -->
<!-- ```{r} -->
<!-- #obsef1%>% -->
<!--  # dplyr::filter(Ture!="No") -->
<!-- statWE2<-obsNode%>% -->
<!--  filter(Variable == "NodeNumber") %>% -->
<!--   filter(Water=="irr")%>% -->
<!--   filter(Defoliation=="LL")%>% -->
<!--   mutate(GrowthSeason=factor(GrowthSeason))%>% -->
<!--   group_by(GrowthSeason,Collection) %>% -->
<!--   group_by(Name,GrowthSeason,Rotation,Collection,Tmean,Pmean) %>% -->
<!--   do(mod = lm(TTWES2~Observed,data=.)) %>% -->
<!--   mutate(R2WE2 = summary(mod)$r.squared) %>% -->
<!--   mutate(PhylloWE2 = summary(mod)$coeff[2]) %>% -->
<!--   dplyr::select(-mod) -->

<!--   WE2R2<-statWE2%>% -->
<!--   group_by(Collection)%>% -->
<!--   mutate(meanR2WE2=mean(R2WE2)) -->
<!--   WE2R2 -->
<!--   write.csv(WE2R2,"D:/R/Phyllo/WE2R2.csv", row.names = FALSE) -->

<!-- ``` -->


### Combine the Phyllo data together
```{r,fig.height=5, fig.width=10,warning=FALSE}
multmerge = function(mypath){
filenames=list.files(path=mypath, full.names=TRUE)
datalist = lapply(filenames, function(x){read.csv(file=x,header=T)})
Reduce(function(x,y) {merge(x,y)}, datalist)}

mergephy=multmerge("D:/R/PhyllochronData")
mergephy

```

```{r}

mergeP<-mergephy%>%
   dplyr::select(Name,GrowthSeason.x,Rotation.x,Collection,Tmean, Ppm,Tbb, PhylloWE,PhylloBr,Phyllofick,ID,ExperimentID) %>%
  tidyr::gather("Variable","Phyllo",PhylloWE:Phyllofick)%>%
  mutate(PhylloTb=as.factor(paste0(Variable,Tbb)))%>%
  mutate(GrowthRotation=as.factor(paste0(GrowthSeason.x,Rotation.x)))
unique(mergeP)

mergeP$Names[mergeP$Name=="Iversen_8Waterirr" ] <-"I8irr"
mergeP$Names[mergeP$Name=="Iversen_91DefoliationLL"] <-"I9LL"
mergeP$Names[mergeP$Name=="Iversen_9SowingDateSD1Waterirr"]<-"I9SD1irr"
mergeP$Names[mergeP$Name=="Iversen_9SowingDateSD2Waterirr"]<-"I9SD2irr"
mergeP$Names[mergeP$Name=="Iversen_9SowingDateSD3Waterirr"]<-"I9SD3irr"
mergeP$Names[mergeP$Name=="Iversen_9SowingDateSD4Waterirr"]<-"I9SD4irr"
mergeP$Names[mergeP$Name=="Iversen_121DefoliationLLFDFD5"]<-"I12DF5"
mergeP

```
##Regression coefficient
```{r}
mergeP%>%
 ggplot(aes(x=Tmean, y=Phyllo, colour=factor(Names)))+geom_point(size=2)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+xlab("Mean air temperature (°C)")+ylab("Phyllochron (°Cd/Leaf)")+
  facet_wrap(~PhylloTb,ncol = 2)+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
 theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
  
```

```{r}

uniPhy <- unique(mergeP$PhylloTb)
Slope.df<-data.frame()

for(i in 1:length(uniPhy) ){
   mergeP.sub <- mergeP %>%
     filter(PhylloTb==uniPhy[i])%>%
   group_by(PhylloTb) %>%
    do(modPhy = lm(Tmean~Phyllo,data=.))%>%
  mutate(R2 = summary(modPhy)$r.squared)%>%
  mutate(slope = summary(modPhy)$coeff[2])%>%
  mutate(P=anova(modPhy)$'Pr(>F)'[1])%>%  
  dplyr::select(-modPhy)
     
   Slope.df <- rbind(Slope.df,mergeP.sub)
  
}
 Slope.df

```


##CV coeffecient of variation
```{r,fig.height=4, fig.width=10}
mergeP

mergePcv<-mergeP%>%group_by(Collection, Variable)%>%
 mutate(meanPhyllo=mean(Phyllo))%>%
  mutate(SDPhyllo=sd(Phyllo))%>%
  mutate(CVPhyllo=SDPhyllo/meanPhyllo)
mergePcv
mergePcv1<-mergePcv%>%group_by(Variable)%>%
  mutate(CVmean=mean(CVPhyllo))

mergePcv%>%
  ggplot(aes(x=PhylloTb,y=CVPhyllo,color=factor(Collection)))+geom_point(size=2)+theme_bw()
  
mergePcv1%>%
  ggplot(aes(x=PhylloTb,y=CVmean))+geom_point(size=2)+theme_bw()
mergePcv1

```

###x-intercept method

```{r}

LAR2<-ObsH%>%  
  group_by(Name,GrowthSeason.x,Rotation.x,Collection,Tmean,Ppm,GrowthRotation,ExperimentID,ID) %>%
  do(mod = lm(Observed~Interval,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
   mutate(R2 = summary(mod)$r.squared)%>%
  mutate(P=anova(mod)$'Pr(>F)'[1])%>%  
  mutate(intcp= summary(mod)$coeff[1])%>%
  dplyr::select(-mod)
LAR.ana<- ObsH%>%  
  group_by(Collection,ExperimentID) %>%
  do(mod = lm(Observed~Interval,data=.)) %>%
  mutate(slope = summary(mod)$coeff[2]) %>%
   mutate(R2 = summary(mod)$r.squared)%>%
  mutate(P=anova(mod)$'Pr(>F)'[1])%>%  
  mutate(intcp= summary(mod)$coeff[1])%>%
  dplyr::select(-mod)
```

```{r,width=8, height=6}
library(plyr)
LAR.NEW<-LAR2%>%
  dplyr::filter(Rotation.x!="6"|Collection!="1997_2001")%>%
  mutate(NAR=slope)%>%
  dplyr::filter(Collection!="2014_2019")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::select(Name, Collection, GrowthRotation, NAR,Tmean,Ppm,ExperimentID,ID)
 #dplyr::filter(Collection==C("2000_2002","1997_2001","2014_2018","2002_2004"))
LAR.NEW$Collection

lm_eqn <- function(LAR.NEW){
  m <- lm(NAR ~ Tmean, LAR.NEW);
  eq <- substitute(italic(y) == Tmean + NAR %.% italic(Tmean)*","~~italic(R)^2~"="~r2, 
                   list(Tmean = format(coef(m)[1], digits = 2), 
                        NAR = format(coef(m)[2], digits = 2), 
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));                 
}


eqns <- ddply(LAR.NEW,.(ExperimentID),lm_eqn)
#df2 <- data.frame(eq = unclass(eqns), Collection = as.numeric(names(eqns)))


a<-ggplot(LAR.NEW, aes(x=Tmean, y=NAR))+
  geom_point()+theme_bw()+xlab("Mean air temperature (°C)")+
  geom_text(data = eqns, aes(x = 13, y = 0.48, label = V1), size=4.7,
          color = 'black',  parse = TRUE)+
 ylab(bquote(bold('Node appearance rate ('*node~day^-1*')')))+
  scale_x_continuous(limits=c(5,20))+
  facet_wrap(~ExperimentID)+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+
  #remove grid lines 
   theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"))
    #ggsave("D:/R/Pictures/Node/Node apparence rate.png", width=8, height=6, dpi=500)
a
detach(package:plyr)
```



```{r}
LAR2
  #dplyr::filter(Rotation!="6"|Collection!="1997_2001")
LAR2.lm=lm(slope~Tmean,data=LAR2)
summary(LAR2.lm)
predict(LAR2.lm, LAR2, interval="predict")
```


```{r}

# LARs<-LAR1%>%
#   dplyr::filter(Collection=="2014_2018")
# 
# LAR.lm = lm(Observed ~ TTS2, data=LARs) 
# LAR.res = resid(LAR.lm)
# 
# 
# plot(LARs$Clock.Today, LAR.res, ylab="Residuals", xlab="Date") 
# abline(0, 0) 

```


#load Rotation and Growth season
```{r,fig.height=6, fig.width=8}
library(plyr)
phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
PhyPp<- merge(StartGrazing1,mergeP,by=c("Name","Collection","GrowthRotation"))

lm_eqn1 <- function(PhyPp){
  m <- lm(Phyllo~Ppm , PhyPp);
  eq <- substitute(italic(y) == Ppm + Phyllo %.% italic(Ppm)*","~~italic(R)^2~"="~r2, 
                   list(Ppm = format(coef(m)[1], digits = 2), 
                        Phyllo = format(coef(m)[2], digits = 2), 
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));                 
}


eqs <- ddply(PhyPp,.(Trend,Stage),lm_eqn1)
#df2 <- data.frame(eq = unclass(eqns), Collection = as.numeric(names(eqns)))
#ylab(bquote(bold('LEAR ('*m^2~m^-2~'°Cd'^-1*')')))

PhyPp
mergeP

PhyPp%>%
  #dplyr::filter(Rotation!="1")%>%
  #dplyr::filter(Rotation!="7")%>%
  #dplyr::filter(Name!="Iversen_8Waterirr"|GrowthSeason!="3")%>%
  #dplyr::filter(Stage!="Seedling")%>%
  dplyr::filter(PhylloTb=="PhylloBr1")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  ggplot(aes(x=Ppm, y=Phyllo,label=GrowthRotation,color=ID))+geom_text()+theme_bw()+xlab("Mean photoperiod (h)")+ylab(bquote(bold('Phyllochron ('*'°Cd'~'main node'^-1*')')))+
  geom_text(data = eqs, aes(x =13, y = 78, label = V1), 
          color = 'black',  parse = TRUE)+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+
  facet_grid(Trend~Stage)+
  #facet_wrap(~Stage,ncol = 2)+
  #geom_point(size=2)+
   scale_y_continuous(breaks = seq(0, 70, by =20), limits=c(0,78))+
  mytheme3+theme(legend.title = element_blank())
 #ggsave("D:/R/Pictures/Node/phyll.png", width=8, height=6, dpi=500)
   detach(package:plyr)
```
#load Rotation and Growth season for poster
```{r,fig.height=6, fig.width=8}
library(plyr)
phyll <- "D:\\R\\"
StartGrazing <- read.table(paste0(phyll, "ExperimentList.txt"), 
                      header = TRUE)
StartGrazing1<-StartGrazing %>%
  mutate(GrowthRotation= as.factor(paste0(GrowthSeason,Rotation)))
PhyPp<- merge(StartGrazing1,mergeP,by=c("Name","Collection","GrowthRotation"))

lm_eqn1 <- function(PhyPp){
  m <- lm(Phyllo~Ppm , PhyPp);
  eq <- substitute(italic(y) == Ppm + Phyllo %.% italic(Ppm)*","~~italic(R)^2~"="~r2, 
                   list(Ppm = format(coef(m)[1], digits = 2), 
                        Phyllo = format(coef(m)[2], digits = 2), 
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));                 
}


eqs <- ddply(PhyPp,.(Trend,Stage),lm_eqn1)
#df2 <- data.frame(eq = unclass(eqns), Collection = as.numeric(names(eqns)))
#ylab(bquote(bold('LEAR ('*m^2~m^-2~'°Cd'^-1*')')))

PhyPp
mergeP

PhyPp%>%
  #dplyr::filter(Rotation!="1")%>%
  #dplyr::filter(Rotation!="7")%>%
  #dplyr::filter(Name!="Iversen_8Waterirr"|GrowthSeason!="3")%>%
  #dplyr::filter(Stage!="Seedling")%>%
  dplyr::filter(PhylloTb=="PhylloBr1")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  ggplot(aes(x=Ppm, y=Phyllo,label=GrowthRotation,color=ID))+geom_text()+theme_bw()+xlab("Mean photoperiod (h)")+ylab(bquote(bold('Phyllochron ('*'°Cd'~'main node'^-1*')')))+
  geom_text(data = eqs, aes(x =13, y = 78, label = V1), 
          color = 'black',  parse = TRUE)+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey")+
  facet_grid(Trend~Stage)+
  #facet_wrap(~Stage,ncol = 2)+
  #geom_point(size=2)+
   scale_y_continuous(breaks = seq(0, 70, by =20), limits=c(0,78))+
  mytheme3+theme(legend.title = element_blank())
 #ggsave("D:/R/Pictures/Node/phyll.png", width=8, height=6, dpi=500)
   detach(package:plyr)
```




```{r}
PhyPpD<-PhyPp%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(Trend=="Dec")
mod<-lm(PhyPpD$Phyllo~PhyPpD$Ppm)
summary(mod)

PhyPpI<-PhyPp%>%
  dplyr::filter(Stage=="Regrowth")%>%
  dplyr::filter(Trend!="Dec")
mod<-lm(PhyPpI$Phyllo~PhyPpI$Ppm)
summary(mod)
```




## Define stats function

* Using Gauch et al. 2003 (Model evaluation by comparison of model-based predictions and measured values. Agron. J. 95, 1442-1446) 
```{r Stats, include = TRUE, echo=FALSE, warning=FALSE, fig.height=8, fig.width=8}

# # R2
# testDF <- data.frame(a=c(1,2,3,4,5), b=c(10,20,10,40,50))
# 
# myR2 <- function(p,o) {
#  return(summary(lm(p~o, na.action=na.exclude))$r.squared) 
# }
# 
# testDF %>%
#   summarise(thisR2 = myR2(a,b))

# gauch MSE components
gauchStats <- function(sim, meas) {

  n_s <- length(sim)
  n_m <- length(meas)
  model <- lm(meas~sim)
  sim_sq <- sum((sim - mean(sim))^2)
  mes_sq <- sum((meas - mean(meas))^2)
  r2 <- summary(model)$r.squared
  slope <- model$coefficients[[2]]

  sb <- (sum(mean(meas)) - sum(mean(sim)))^2
  nu <- (1-slope)^2 * (sim_sq/n_s)
  lc <- (1-r2) * (mes_sq/n_m)
  msd <- sb+nu+lc

  sb_r <- round((sb/msd)*100,1)
  nu_r <- round((nu/msd)*100,1)
  lc_r <- round((lc/msd)*100,1)

  msd_r <- sb_r+nu_r+lc_r

  # select which variables to output
  out <- c(sb_r,nu_r,lc_r, msd_r, round(r2*100,1))

  return(out)

}
```

## Test stats functions used

```{r}
s <- c(4231.972,3935.604,3779.652,3627.687,3363.499,3230.566,2868.114,2868.827)
m <- c(4987.66,5636.09,4754.06,4114.53,4141.72,3704.06,5142.19,4762.03)

x <- gauchStats(s,m)

tempDf <- data.frame(statName=c("SB","NU","LC","r_MSD","R2"), statValue=x)
# kable(tempDf, digits= 2)
tempDf2 <- data.frame(Predicted=s, Observed=m)

x <- tempDf2 %>%
  summarise(
    n = n(),
    r2 = gauchStats(Predicted,Observed)[5],
  #  rmse = round(rmse(Predicted,Observed),0),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,1),
    nse = round(NSE(Predicted,Observed),1),
    sb = gauchStats(Predicted,Observed)[1],
  nu = gauchStats(Predicted,Observed)[2],
  lc = gauchStats(Predicted,Observed)[3]
  ) %>% 
  t() 

df <- data.frame(stat = row.names(x),statvalue = x[,1])

df %>%
  kable(format = "markdown")
```
## Load simulated database
## create function to read data (Justin's script)
```{r LoadSim, include = FALSE, echo=FALSE, warning=FALSE, fig.height=8, fig.width=8}
GetApsimNGTable <- function(dbLoc, table) 
{
  connection <- dbConnect(SQLite(), dbname = dbLoc, flags = SQLITE_RW)
  table <- dbReadTable(connection, table, row.names=NULL)
  dbDisconnect(connection)
  return(table)
}

```
# load address of db
# set table to be enquierd
# load table into an object
# make it a dataframe
# change date to corerct format 
# explore the df
```{r}
db.address <- "D:\\APSIMX2\\Prototypes\\Lucerne\\LucerneValidation.db"
tableName<-"Report"
DbTable <- GetApsimNGTable(db.address,tableName)
df <- as.data.frame(DbTable)
df$Clock.Today <- ymd_hms(df$Clock.Today)
str(df)
summary(df)
head(df) # simulation results
```
# get sim names (different table)
# merge names 
# remove unecessary variables
```{r}
simNameDf <- as.data.frame (GetApsimNGTable(db.address,"_Simulations"))
myDb <- merge(df, simNameDf, by.x= c("SimulationID"), by.y= c("ID"))


#str(myDb)
head(myDb)
summary(myDb)

# myDb %>%
#   dplyr::select(Name) %>%
#   unique()

```
## Prepare merge
## Add info for merging
## select variables that are for comparing with observed data

```{r}
simD <- myDb %>%
  dplyr::select(Name,Clock.Today,LAI,Height,shootbiomass,RootWt, StemWt, LeafWt,NodeNumber) %>%
  tidyr::gather("Variable","Predicted",LAI:NodeNumber) %>%
  mutate(Name = as.factor(Name)) %>%
  mutate(Variable = as.factor(Variable)) %>%
  mutate(Clock.Today = ymd_hms(Clock.Today))

head(simD)
summary(simD)


head(obsNode)
mergedf<-merge(obsA,simD,by=c("Clock.Today","Name","Variable"))
summary(mergedf)
str(mergedf)
mergedf

```


## Node number
#Time series
## obs Vs Pre for each experiment
## 1997-2001
```{r,fig.height=4, fig.width=9}

obsNode1<-obsA%>%
  dplyr::filter(Collection=="1997_2001")%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::filter(Name=="Iversen_8Waterirr")%>%
  dplyr::filter(Clock.Today>"1997-08-01")%>%
  dplyr::filter(Clock.Today<"2001-08-01")
  
  
   
 simD1<-simD%>%
   mutate(Clock.Today = ymd_hms(Clock.Today))%>%
   dplyr::filter(Clock.Today>"1997-08-01")%>%
   dplyr::filter(Clock.Today<"2001-08-01")%>%
   dplyr::filter(Variable=="NodeNumber")%>%
   dplyr::filter(Name=="Iversen_8Waterirr")
 str(simD1)
 simD1%>%
 ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
 facet_wrap(~ID,ncol = 2)+
 geom_point(data=obsNode1, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
 theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab("Node number")+
    #remove grid lines 
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))+
   annotate("text", x=ymd_hms("1999-10-24 12:00:00"), y=17, size = 5, label ="paste(R_RMSD == 23,'%')", parse=T)
 #ggsave("D:/R/Pictures/Node/Iversen_8Waterirrnodenumber.png", width=8, height=4, dpi=500)

```


##2002-2004
```{r,  fig.height=4, fig.width=8}
obsNode2<-obsNode%>% 
  dplyr::filter(Collection=="2002_2004")%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")

simD2<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Clock.Today>"2002-06-01")%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::filter(Name=="Iversen_91DefoliationLL")
str(simD2)
simD2%>%
ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
  #facet_wrap(~ID,ncol = 1)+
  geom_point(data=obsNode2, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab("Node number")+
  #remove grid lines 
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))+
  annotate("text", x=ymd_hms("2003-07-24 12:00:00"), y=17, size = 5, label ="paste(R_RMSD == 22.1,'%')", parse=T)
   ggsave("D:/R/Pictures/Node/Iversen_91DefoliationLLnodenumber.png", width=8, height=4, dpi=500)
  #ggsave("D:/R/Pictures/Poster/E3.png", width=8, height=4, dpi=500)
  


```



##2000-2002
```{r,  fig.height=8, fig.width=8}
obsNode3<-obsNode%>%
  dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Variable=="NodeNumber")
 obsNode3 

simD3a<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Clock.Today>"2000-10-24 12:00:00")%>%
  dplyr::filter(Clock.Today<"2002-07-01 12:00:00")%>%
  dplyr::filter(Name==c("Iversen_9SowingDateSD1Waterirr","Iversen_9SowingDateSD2Waterirr","Iversen_9SowingDateSD3Waterirr","Iversen_9SowingDateSD4Waterirr"))%>%
  dplyr::filter(Variable=="NodeNumber")

DF<-data.frame(Name=c("Iversen_9SowingDateSD1Waterirr","Iversen_9SowingDateSD2Waterirr","Iversen_9SowingDateSD3Waterirr","Iversen_9SowingDateSD4Waterirr"),ID= c("E2ILLS1","E2ILLS2","E2ILLS3","E2ILLS4"))
simD3<-merge(DF,simD3a, by=c("Name"))
 G<-simD3%>%
ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
  geom_point(data=obsNode3, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
   facet_wrap(~ID,ncol = 2)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab("Node number")+
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
    axis.text = element_text(face = "bold", vjust = 0.5, size = 14))


dat_text1 <- data.frame(
  label = c("R_RMSE=22%", "R_RMSE=24.9%", "R_RMSE=23.1%","R_RMSE=18.7%"),
  ID= c("E2ILLS1","E2ILLS2","E2ILLS3","E2ILLS4"),
  x= ymd_hms("2001-03-24 12:00:00", "2001-03-24 12:00:00","2001-03-24 12:00:00","2001-03-24 12:00:00"),
  y=c(18,18,18,18))

 G+geom_text(data=dat_text1, mapping = aes(x=x,y=y, label = label),hjust   = -0.1,vjust   = -1,size=5)

#ggsave("D:/R/Pictures/Node/Iversen_9SowingDatenodenumber.png", width=8, height=8, dpi=500)
  
  
```
##2014-2018
```{r,  fig.height=4, fig.width=8}
obsNode4<-obsNode%>% 
  dplyr::filter(Collection=="2014_2018")%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")

simD4a<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Clock.Today<"2015-01-06")

simD4b<-simD%>%
  mutate(Clock.Today = ymd_hms(Clock.Today))%>%
  dplyr::filter(Variable=="NodeNumber")%>%
  dplyr::filter(Name=="Iversen_121DefoliationLLFDFD5")%>%
  dplyr::filter(Clock.Today>"2015-01-30")
simD4<-rbind(simD4a,simD4b)
  
str(simD4)
simD4%>%
ggplot(aes(x=Clock.Today,y=Predicted))+geom_line(size=1)+theme_bw()+
  facet_wrap(~ID,ncol = 1)+
  geom_point(data=obsNode4, aes(x=Clock.Today1, y=Observed),colour="green",size=3)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Date")+ylab("Node number")+
  #remove grid lines 
   theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))+
   annotate("text", x=ymd_hms("2016-07-24 12:00:00"), y=18, size = 5, label ="paste(R_RMSD == 26.3,'%')", parse=T)
   #ggsave("D:/R/Pictures/Node/Iversen_121DefoliationLLFDFD5nodenumber.png", width=8, height=4, dpi=500)
  
  


```

# Statistic and Graph
```{r,fig.height=6, fig.width=8}
mergedf
summary(mergedf)
str(mergedf)

 d<-mergedf %>%
    dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  ggplot(aes(x=Observed, y= Predicted, colour= factor(Name))) +
  geom_point(size=2)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1)+
  ggtitle("Node Number")+
  facet_wrap(~ID, ncol = 4)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Observed")+ylab("Predicted")+
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))
 d
   #ggsave("D:/R/Pictures/Node/nodenumber.png", width=8, height=6, dpi=500)
```

```{r,fig.height=4, fig.width=8}
# # fit model and get lower/upper 95% confidence limits at the observed x's
# m <- lm(yvalues ~ xvalues, data = d)
# mp <- predict(m, interval = 'conf')
# 
# # bind predictions to original data and plot
# d2 <- cbind(d, mp)
# p <- ggplot(d2, aes(x = xvalues, y = yvalues))
# p + geom_point() + geom_smooth(method = 'lm', se = FALSE) +
#     geom_line(aes(y = upr), color = 'red', linetype = 2) +
#     geom_line(aes(y = lwr), color = 'red', linetype = 2) 


mergedf1<-mergedf%>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  dplyr::filter(Collection!="2010_2012")%>%
  dplyr::filter(ID==c("E3ILL","E5ILLF5"))
summary(mergedf1)
str(mergedf1)
m <- lm(Predicted ~ Observed, data = mergedf1)
mp <- predict(m, interval = 'conf')
d2 <- cbind(mergedf1, mp)

p1<-d2 %>%
    
  ggplot(aes(x=Observed, y= Predicted,color=ID))+
geom_point(size=2,colour="blue")+theme_bw()+ geom_smooth(method = 'lm', se = FALSE, color="black") +
    geom_line(aes(y = upr), color = 'black', linetype = 3,size=1) +
    geom_line(aes(y = lwr), color = 'black', linetype = 3,size=1)+
  #geom_smooth(method = "lm", se = TRUE, linetype = 3, colour="black") +
  geom_abline(intercept = 0, slope = 1,size=1,color="purple") +
  coord_fixed(ratio = 1)+
  ggtitle("Node Number")+
  #facet_wrap(~ID, ncol = 4)+
  theme(legend.title=element_blank(),legend.position = "blank")+
  xlab("Observed")+ylab("Predicted")+
  theme(
     panel.spacing=unit(.01, "lines"),
     panel.border = element_rect(colour = "black",size=1), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black",size = 1),
     axis.text.x = element_text(face = "plain", color = "black", size = 14, vjust=0.5, hjust = 1),
     axis.text.y = element_text(face = "plain", color = "black", size = 14),
     axis.title.x=element_text(face="bold",colour="black",size = 14),
     axis.title.y=element_text(face="bold",colour="black",size = 14),
     strip.background = element_rect(colour = "black", fill = "white",size=1),
     strip.text.x = element_text(size=14, angle=0, face = "plain"), 
     strip.text.y = element_text(size=14, face="plain"),
     legend.title = element_text(colour="black", size=14, face="bold"),
     axis.text = element_text(face = "bold", vjust = 0.5, size = 14))
   ggsave("D:/R/Pictures/Poster/nodenumber.png", width=8, height=4, dpi=500)
```












## 2002-2004

```{r}
mergedf
summary(mergedf)
str(mergedf)

mergedf %>%
    dplyr::filter(Collection=="2002_2004")%>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  ggplot(aes(x=Observed, y= Predicted, 
          colour= factor(Name))) +
  geom_point(size=3)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1)+
  ggtitle("Node Number")+
  facet_grid(GrowthSeason~Rotation)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Observed")+ylab("Predicted")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
  theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
```
```{r}
mergedf %>%
    dplyr::filter(Collection=="2014_2018")%>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  ggplot(aes(x=Observed, y= Predicted, 
          colour= factor(Name))) +
  geom_point(size=3)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1)+
  ggtitle("Node Number")+
  facet_grid(GrowthSeason~Rotation)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Observed")+ylab("Predicted")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
  theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
```



## 2000-2002

```{r}
mergedf
summary(mergedf)
str(mergedf)

mergedf %>%
    dplyr::filter(Collection=="2000_2002")%>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  ggplot(aes(x=Observed, y= Predicted, 
          colour= factor(Name))) +
  geom_point(size=3)+theme_bw()+
  geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1)+
  ggtitle("Node Number")+
  facet_grid(GrowthSeason~Rotation)+
  theme(legend.title=element_blank())+xlab("Observed")+ylab("Predicted")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
  theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
```




```{r}
mergedf %>%
    dplyr::filter(Collection=="1997_2001")%>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  ggplot(aes(x=Observed, y= Predicted, 
          colour= factor(Name))) +
  geom_point(size=3)+theme_bw() +
   geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1) +
  ggtitle("Node Number")  +
  facet_grid(GrowthSeason~Rotation)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Observed")+ylab("Predicted")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
  theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
```

```{r, warning=FALSE}
mergedf %>%
    dplyr::filter(Collection=="1997_2001")%>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
  ggplot(aes(x=Observed, y= Predicted, 
          colour= factor(Name))) +
  geom_point(size=3)+theme_bw() +
   geom_smooth(method = "lm", se = TRUE, linetype = 1, colour="darkgrey") +
  geom_abline(intercept = 0, slope = 1) +
  coord_fixed(ratio = 1) +
  ggtitle("Node Number")  +
  # facet_grid(.~Rotation) + # Rotation
  facet_wrap(~GrowthSeason, ncol = 4)+
  theme(legend.title=element_blank(),legend.position = "blank")+xlab("Observed")+ylab("Predicted")+
  theme(axis.title.x=element_text(face="bold",colour="black",size = 12))+
  theme(axis.title.y=element_text(face="bold",colour="black",size = 12))
```

## RMSE

```{r}
str(mergedf)

mergedf %>%
  dplyr::filter(Variable== "NodeNumber") %>% 
   dplyr::filter(Water== "irr")%>%
  dplyr::filter(Defoliation== "LL")%>%
 #filter(Variable == "NodeNumber") %>%
 filter(Collection!="2010_2012")%>%
  mutate(Rotation= as.factor(Rotation))%>%
  mutate(GrowthSeason=as.factor(GrowthSeason))%>%
  group_by(ID) %>%
  summarise(
    n = n(),
    r2 = gauchStats(Predicted,Observed)[5],
  #  rmse = round(rmse(Predicted,Observed),0),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,1),
    nse = round(NSE(Predicted,Observed),2),
    sb = gauchStats(Predicted,Observed)[1],
  nu = gauchStats(Predicted,Observed)[2],
  lc = gauchStats(Predicted,Observed)[3]
  ) 

  
```



